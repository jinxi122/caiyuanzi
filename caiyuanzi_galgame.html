<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èœåœ’å­ğŸ¥¬ - Galgameç‰ˆæœ¬</title>
    <link rel="stylesheet" href="css/galgame.css">
    <link rel="stylesheet" href="css/sylbt.css">
    <style>
        /* å¯¼èˆªæ æ ·å¼ - å†…è”æ ·å¼é¿å…å†²çª */
        #syszl {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1002;
            padding: 8px 0;
            transition: all 0.3s ease;
            display: flex;
            height: auto;
            min-height: 40px;
        }
        
        #syszl h3 {
            color: #ffffff;
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            padding: 5px 15px;
            line-height: 1.2;
        }
        
        #syszl h3:first-child { margin-left: 150px; }
        #syszl h3:nth-child(2) { margin-left: 800px; }
        #syszl h3:nth-child(3),
        #syszl h3:nth-child(4),
        #syszl h3:nth-child(5) { margin-left: 100px; }
        
        #syszl h3 a { 
            color: inherit;
            text-decoration: none;
            display: block;
            padding: 0;
            font-size: 16px;
            transition: color 0.3s ease;
        }
        
        #syszl h3 a:hover { color: #d4af37; }
        /* å¯¹è¯æ¡†å¯æ»šåŠ¨å¹¶ä¿ç•™æ¢è¡Œï¼Œé€‚é…é•¿æ®µæ–‡æœ¬ */
        .dialogue-text {
            white-space: pre-wrap;
            max-height: 240px;
            overflow-y: auto;
            padding: 10px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- NOTE: ä½¿ç”¨ç»Ÿä¸€çš„ bgMusic å…ƒç´ ï¼ˆé¡µé¢åº•éƒ¨å®šä¹‰ï¼‰ï¼Œç§»é™¤é‡å¤ background-music å…ƒç´  -->
    
    <!-- å¯¼èˆªæ  -->
    <nav id="syszl">
        <h3><a href="index.html">é¦–é¡µ</a></h3>
        <h3><a href="index.html#news">æ–°é—»</a></h3>
        <h3><a href="index.html#join-us">åŠ å…¥æˆ‘ä»¬</a></h3>
        <h3><a href="caiyuanzi.html">èœåœ’å­ğŸ¥¬</a></h3>
        <h3><a href="huamingce.html">èŠ±åå†Œ</a></h3>
    </nav>

    <!-- Galgameæ¸¸æˆåŒºåŸŸ -->
    <div class="galgame-container">
        <!-- èƒŒæ™¯å›¾ç‰‡å±‚ -->
        <div id="background-image" class="background-image" style="background-image: url('img/6899f2b2eb6a41d24a84ea1cf2S4JuHj06.png')"></div>
        
        <!-- èƒŒæ™¯é®ç½©å±‚ -->
        <div class="background-overlay"></div>
        
        <!-- åœºæ™¯æ ‡é¢˜ -->
        <h1 class="scene-title">èœåœ’å­ç‰©èª</h1>
        
        <!-- è¿›åº¦ä¿¡æ¯ -->
        <div class="story-progress">
            ç« èŠ‚: <span id="chapter">1</span> | 
            å¥½æ„Ÿåº¦: <span id="affection">0</span> | 
            åœºæ™¯: <span id="scene">1</span>
        </div>
        
        <!-- è§’è‰²å›¾ç‰‡åŒºåŸŸ -->
        <div class="character-area">
            <img id="character-img" class="character-image" alt="" onerror="handleImageError(this)">
        </div>
        <!-- è°ƒè¯•é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼Œç‚¹å‡»æŒ‰é’®æ˜¾ç¤ºï¼‰ -->
        <div id="debug-panel" style="display:none;position:fixed;right:10px;bottom:10px;background:rgba(0,0,0,0.6);color:#0f0;padding:8px;border-radius:6px;font-size:12px;z-index:2000;max-width:320px;white-space:pre-wrap;"></div>
        
        <!-- å¯¹è¯æ¡†åŒºåŸŸ -->
        <div class="dialogue-area" onclick="nextSentence()">
            <div id="character-name" class="character-name">ç³»ç»Ÿ</div>
            <div id="dialogue-text" class="dialogue-text">
                æ¬¢è¿æ¥åˆ°èœåœ’å­ç‰©èªï¼ç‚¹å‡»å¼€å§‹æ¸¸æˆã€‚
            </div>
            <button id="continue-btn" class="continue-btn" onclick="nextSentence()">ç»§ç»­</button>
        </div>
        
        <!-- é€‰æ‹©æŒ‰é’®åŒºåŸŸ -->
        <div class="choice-area">
            <div id="choice-buttons" class="choice-buttons">
                <button class="choice-btn" onclick="showInstructions()">æ¸¸æˆè¯´æ˜</button>
                <button class="choice-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
            </div>
            <div style="margin-top:10px; font-size:14px; color:#ddd;">
                <button id="unlock-audio" style="margin-left:10px;padding:6px 10px;">è§£é”éŸ³é¢‘</button>
                <button id="quick-test" style="margin-left:8px;padding:6px 10px;">ä¸€é”®åŠ è½½æ‰©å±•å‰§æƒ…å¹¶å¼€å§‹</button>
                <button id="music-toggle" style="margin-left:8px;padding:6px 10px;background:#d4af37;color:#000;">ğŸµ éŸ³ä¹: å…³</button>
                <button id="sfx-toggle" style="margin-left:8px;padding:6px 10px;background:#888;color:#fff;">ğŸ”Š éŸ³æ•ˆ: å¼€</button>
                <label style="margin-left:8px;color:#ddd;">éŸ³é‡:</label>
                <input id="music-volume" type="range" min="0" max="1" step="0.01" value="0.7" style="vertical-align:middle;margin-left:6px;">
                <label style="margin-left:8px;color:#ddd;">SFXéŸ³é‡:</label>
                <input id="sfx-volume" type="range" min="0" max="1" step="0.01" value="0.85" style="vertical-align:middle;margin-left:6px;">
                <button id="debug-toggle" style="margin-left:8px;padding:6px 10px;background:#444;color:#fff;">æ˜¾ç¤ºè°ƒè¯•</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥JavaScriptæ–‡ä»¶ -->
    <!-- èƒŒæ™¯éŸ³ä¹ï¼ˆä»…åœ¨æ¸¸æˆå¼€å§‹æ—¶æ’­æ”¾ï¼‰ -->
    <audio id="bgMusic" src="music/jin.mp3" loop preload="auto"></audio>
    <script src="JavaScript/galgamewa.js"></script>
    <script src="JavaScript/galgame.js"></script>
    
    <!-- èƒŒæ™¯å›¾ç‰‡ç®¡ç†è„šæœ¬ -->
    <script>
        // åœºæ™¯èƒŒæ™¯å›¾ç‰‡æ˜ å°„ - å·²ç»Ÿä¸€ä¸ºä»¥ toxiang å¼€å¤´çš„æ–‡ä»¶å
        const backgroundImages = {
            "ç³»ç»Ÿ": {
                "default": "img/toxiang1 (1).png",
                "èœå›­å…¥å£": "img/toxiang1 (1).png",
                "ç¥ç§˜èœå›­": "img/toxiang1 (2).png"
            },
            "ç™½èœç²¾çµ ğŸ¥¬": {
                "default": "img/toxiang1 (4).png",
                "ç™½èœå›­": "img/toxiang1 (4).png",
                "ç™½èœç²¾çµçš„å®¶": "img/toxiang1 (5).png"
            },
            "èƒ¡èåœæˆ˜å£« ğŸ¥•": {
                "default": "img/toxiang1 (6).png",
                "èƒ¡èåœç”°": "img/toxiang1 (6).png",
                "å®ˆå«å“¨æ‰€": "img/toxiang1 (8).png"
            },
            "å…¶ä»–è§’è‰²": {
                "default": "img/toxiang1 (1).png",
                "èœå›­ä¸­å¿ƒ": "img/toxiang1 (12).png",
                "ç¥ç§˜åŒºåŸŸ": "img/toxiang1 (13).png"
            }
        };

        // èµ„äº§åˆ«åæ˜ å°„ï¼šæŠŠè§„èŒƒåæ˜ å°„åˆ°ä»“åº“ä¸­å®é™…å­˜åœ¨çš„æ–‡ä»¶åï¼Œé¿å…ä¿®æ”¹äºŒè¿›åˆ¶èµ„æº
        // å¦‚æœä½ åç»­å°†æ–‡ä»¶é‡å‘½ååˆ°è§„èŒƒåï¼Œè¿™é‡Œå¯ä»¥åˆ é™¤æˆ–åå‘ä¿®æ”¹ã€‚
        const assetAlias = {
            // toxiang ç³»åˆ—ï¼ˆç¤ºä¾‹æ˜ å°„ï¼‰
            'img/toxiang1.png': 'img/toxiang1 (1).png',
            'img/toxiang2.png': 'img/toxiang1 (2).png',
            'img/toxiang3.png': 'img/toxiang1 (3).png',
            'img/toxiang4.png': 'img/toxiang1 (4).png',
            'img/toxiang5.png': 'img/toxiang1 (5).png',
            'img/toxiang6.png': 'img/toxiang1 (6).png',
            'img/toxiang7.png': 'img/toxiang1 (7).png',
            'img/toxiang8.jpg': 'img/toxiang1 (8).png',
            'img/toxiang9.jpg': 'img/toxiang1 (9).png',
            'img/toxiang10.jpg': 'img/toxiang1 (10).png',
            'img/toxiang11.png': 'img/toxiang1 (11).png',
            'img/toxiang12.png': 'img/toxiang1 (12).png',
            'img/toxiang13.png': 'img/toxiang1 (13).png'
        };

        // å…¨å±€è§£æå‡½æ•°ï¼šå°†ä¼ å…¥è·¯å¾„æ˜ å°„åˆ°å­˜åœ¨çš„æ–‡ä»¶ï¼ˆè‹¥æ— åˆ«ååˆ™åŸæ ·è¿”å›ï¼‰
        window.getAsset = function(p) {
            try {
                if (!p || typeof p !== 'string') return p;
                // å…ˆå°è¯•ç›´æ¥åˆ«åè¡¨
                if (assetAlias[p]) return assetAlias[p];
                // å°è¯•å¯¹ä¸å¸¦ img/ å‰ç¼€çš„åç§°è¿›è¡Œè¡¥é½
                if (/^toxiang\d+/.test(p)) {
                    const key = 'img/' + p;
                    if (assetAlias[key]) return assetAlias[key];
                }
                // å¦åˆ™è¿”å›åŸå€¼ï¼ˆé¡µé¢ä¸Šçš„é¢„åŠ è½½ä¼šå¤„ç†å›é€€ï¼‰
                return p;
            } catch (e) { return p; }
        };

        // åœºæ™¯èƒŒæ™¯æè¿°æ˜ å°„
        const sceneBackgrounds = {
            1: {
                0: { character: "ç³»ç»Ÿ", location: "èœå›­å…¥å£" },
                1: { character: "ç™½èœç²¾çµ ğŸ¥¬", location: "ç™½èœå›­" },
                2: { character: "ç™½èœç²¾çµ ğŸ¥¬", location: "ç™½èœç²¾çµçš„å®¶" }
            },
            2: {
                0: { character: "èƒ¡èåœæˆ˜å£« ğŸ¥•", location: "èƒ¡èåœç”°" },
                1: { character: "èƒ¡èåœæˆ˜å£« ğŸ¥•", location: "å®ˆå«å“¨æ‰€" }
            }
        };

        // æŒ‡å®šç”¨æˆ·æä¾›çš„é»˜è®¤èƒŒæ™¯å›¾ï¼ˆä¼˜å…ˆæ˜¾ç¤ºï¼‰
        const BG_DEFAULT = 'img/6899f2b2eb6a41d24a84ea1cf2S4JuHj06.png';
        // æœ¬åœ°å­˜åœ¨çš„å›é€€èƒŒæ™¯å›¾ï¼ˆä»“åº“ä¸­å­˜åœ¨çš„æ–‡ä»¶ï¼‰
        const BG_FALLBACK = 'img/yyslscstx.png';

        // è‹¥å›¾ç‰‡åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨å›é€€å›¾ï¼ˆä¹Ÿç”¨äº <img> çš„ onerrorï¼‰
        function handleImageError(imgEl) {
            try {
                if (!imgEl) return;
                if (imgEl.dataset && imgEl.dataset._errored) return;
                imgEl.dataset._errored = '1';
                // å¦‚æœè¿™æ˜¯è§’è‰²å¤´åƒå…ƒç´ ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒå›é€€ï¼Œå¦åˆ™ä½¿ç”¨èƒŒæ™¯å›é€€
                if (imgEl.id === 'character-img') {
                    imgEl.src = 'img/toxiang1 (11).png';
                } else {
                    imgEl.src = BG_FALLBACK;
                }
            } catch (e) { /* ignore */ }
        }

        // æ›´æ–°èƒŒæ™¯å›¾ç‰‡ï¼ˆå¸¦é¢„åŠ è½½ä¸å›é€€ï¼‰
        function updateBackground(chapter, scene) {
            const bgElement = document.getElementById('background-image');
            const sceneInfo = sceneBackgrounds[chapter] && sceneBackgrounds[chapter][scene];
            let bgImage = BG_DEFAULT; // é¦–é€‰ä½¿ç”¨ç”¨æˆ·æŒ‡å®šèƒŒæ™¯

            // å§‹ç»ˆä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„èƒŒæ™¯ï¼Œå¿½ç•¥ toxiang ç³»åˆ—æ˜ å°„
            bgImage = BG_DEFAULT;

            // æ·»åŠ æ·¡å…¥æ·¡å‡ºåŠ¨ç”»
            bgElement.style.opacity = '0';

            // é¢„åŠ è½½æ‰€éœ€èƒŒæ™¯ï¼Œè‹¥åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨å›é€€å›¾
            const testImg = new Image();
            testImg.onload = () => {
                setTimeout(() => {
                    const final = (typeof window.getAsset === 'function') ? window.getAsset(bgImage) : bgImage;
                    bgElement.style.backgroundImage = `url('${final}')`;
                    bgElement.style.opacity = '1';
                }, 300);
            };
            testImg.onerror = () => {
                setTimeout(() => {
                    bgElement.style.backgroundImage = `url('${BG_FALLBACK}')`;
                    bgElement.style.opacity = '1';
                }, 300);
            };
            // è§¦å‘åŠ è½½ï¼ˆä½¿ç”¨åˆ«åè§£æä»¥é˜²èµ„æºåä¸åŒï¼‰
            try { testImg.src = (typeof window.getAsset === 'function') ? window.getAsset(bgImage) : bgImage; } catch (e) { testImg.onerror(); }
        }

        // ä¿®æ”¹loadSceneå‡½æ•°ä»¥åŒ…å«èƒŒæ™¯æ›´æ–°
        const originalLoadScene = window.loadScene;
        window.loadScene = function() {
            updateBackground(window.currentChapter, window.currentScene);
            originalLoadScene();
        };

        // åˆå§‹åŒ–èƒŒæ™¯
        document.addEventListener('DOMContentLoaded', function() {
            updateBackground(1, 0);
        });
    </script>
    <!-- å…¥å£é™åˆ¶ä¸AIå£°æ˜ -->
    <div id="entry-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:2000;display:none;align-items:center;justify-content:center;color:#fff;flex-direction:column;">
        <div style="max-width:720px;padding:20px;text-align:center;">
            <h2>è®¿é—®å—é™</h2>
            <p>æ­¤é¡µé¢åªèƒ½é€šè¿‡ç«™å†…â€œèœåœ’å­â€é¡µé¢çš„æŒ‰é’®è¿›å…¥ã€‚è‹¥è¦è¿”å›ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ã€‚</p>
            <div style="margin-top:16px;"><a href="caiyuanzi.html" style="background:#d4af37;color:#000;padding:10px 18px;border-radius:6px;text-decoration:none;">è¿”å›èœåœ’å­</a></div>
        </div>
    </div>

    <script>
        // åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤º AI å‰§æœ¬æ–‡æ¡ˆæ¥æºå£°æ˜
        (function() {
            const banner = document.createElement('div');
            banner.style.cssText = 'position:fixed;top:48px;left:0;right:0;background:rgba(0,0,0,0.85);color:#f5f5f5;padding:6px 10px;text-align:center;z-index:1500;font-size:13px;';
            banner.innerHTML = 'å‰§æœ¬/æ–‡æ¡ˆç”± AI ç”Ÿæˆå¹¶å‚è€ƒç½‘ç»œç´ æï¼›å¦‚éœ€ç‰ˆæƒæˆ–æ¥æºè¯´æ˜ï¼Œè¯·è”ç³»ç«™é•¿ã€‚<br/> éŸ³ä¹æ˜¯éƒ‘æ¶¦æ³½çš„æ§¿ï¼ŒéŸ³æºæ˜¯åœ¨æŠ–éŸ³ä¸Šæ‰¾åˆ°çš„ä¼´å¥ï¼Œå‰§æœ¬ä¸­çš„å›¾åƒæ¥è‡ªç‡•äº‘åå…­å£°ã€‚';
            document.body.appendChild(banner);

            // å…¥å£æ ¡éªŒï¼šå…è®¸æ¥è‡ª caiyuanzi.html çš„é“¾æ¥æˆ–å¸¦ ?from=caiyuanzi çš„è®¿é—®
            const params = new URLSearchParams(window.location.search);
            const fromParam = params.get('from');
            const ref = document.referrer || '';
            const allowed = (fromParam === 'caiyuanzi') || ref.indexOf('caiyuanzi.html') !== -1;

            if (!allowed) {
                // æ˜¾ç¤ºé®ç½©é˜»æ­¢äº¤äº’
                const overlay = document.getElementById('entry-overlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                }
            }
        })();
    </script>
    <script>
        // è®©å¯¹è¯æ–‡æœ¬ä¸­çš„æ¢è¡Œç¬¦æ˜¾ç¤ºä¸º HTML æ¢è¡Œï¼Œå¹¶ä¿æŒé•¿æ–‡æœ¬å¯æ»šåŠ¨
        (function() {
            const dialog = document.getElementById('dialogue-text');
            if (!dialog) return;

            // ä½¿ç”¨ MutationObserver ç›‘å¬æ–‡æœ¬å˜åŒ–ï¼Œå¹¶å°†æ–‡æœ¬èŠ‚ç‚¹ä¸­çš„æ¢è¡Œè½¬ä¸º <br>
            const observer = new MutationObserver(() => {
                // é¿å…é‡å¤è®¾ç½® innerHTML å¯¼è‡´å…‰æ ‡/é€‰æ‹©ä¸¢å¤±ï¼Œåªæœ‰åœ¨å­˜åœ¨æ¢è¡Œæ—¶æ›¿æ¢
                const raw = dialog.textContent || '';
                const html = raw.replace(/\n/g, '<br>');
                if (dialog.innerHTML !== html) {
                    dialog.innerHTML = html;
                }
            });

            observer.observe(dialog, { childList: true, characterData: true, subtree: true });

            // è§£é”éŸ³é¢‘ï¼šéƒ¨åˆ†æµè§ˆå™¨è¦æ±‚ç”¨æˆ·æ‰‹åŠ¿æ‰èƒ½æ’­æ”¾éŸ³é¢‘ï¼Œç‚¹å‡»æ­¤æŒ‰é’®æ‰§è¡Œä¸€æ¬¡è½»é‡æ’­æ”¾ä»¥è§£é”
            const unlockBtn = document.getElementById('unlock-audio');
            unlockBtn && unlockBtn.addEventListener('click', () => {
                try {
                    // å°è¯•æ’­æ”¾é¡µé¢ä¸Šæ‰€æœ‰ audio å…ƒç´ ï¼ˆå¦‚å­˜åœ¨ï¼‰ï¼Œç«‹å³æš‚åœä»¥å®Œæˆè§£é”
                    const audios = document.querySelectorAll('audio');
                    audios.forEach(a => {
                        a.play().then(() => a.pause()).catch(() => {});
                    });

                    // å¤‡ç”¨ï¼šåˆ›å»ºä¸€ä¸ªçŸ­æ—¶é™éŸ³çš„ AudioContextï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ï¼‰
                    if (window.AudioContext || window.webkitAudioContext) {
                        const Ctx = window.AudioContext || window.webkitAudioContext;
                        const ctx = new Ctx();
                        const o = ctx.createOscillator();
                        const g = ctx.createGain();
                        g.gain.value = 0;
                        o.connect(g); g.connect(ctx.destination);
                        o.start(0);
                        setTimeout(() => { o.stop(); ctx.close(); }, 50);
                    }

                    unlockBtn.textContent = 'å·²è§£é”';
                    unlockBtn.disabled = true;
                    
                    // è§£é”åè‡ªåŠ¨å¼€å¯éŸ³ä¹
                    const musicToggle = document.getElementById('music-toggle');
                    if (musicToggle) {
                        musicToggle.click();
                    }
                } catch (e) {
                    console.warn('è§£é”éŸ³é¢‘æ—¶å‘ç”Ÿé”™è¯¯', e);
                }
            });

            // éŸ³ä¹æ§åˆ¶æŒ‰é’®
            const musicToggle = document.getElementById('music-toggle');
            musicToggle && musicToggle.addEventListener('click', () => {
                if (typeof toggleMusic === 'function') {
                    toggleMusic();
                }
            });

            // éŸ³æ•ˆå¼€å…³ï¼ˆå¹¶åœ¨å…³é—­æ—¶åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„ sfxï¼‰
            const sfxToggle = document.getElementById('sfx-toggle');
            sfxToggle && sfxToggle.addEventListener('click', () => {
                try {
                    window.sfxEnabled = window.sfxEnabled === false ? true : false;
                    sfxToggle.textContent = window.sfxEnabled ? 'ğŸ”Š éŸ³æ•ˆ: å¼€' : 'ğŸ”‡ éŸ³æ•ˆ: å…³';
                    sfxToggle.style.background = window.sfxEnabled ? '#888' : '#444';
                    // è‹¥å…³é—­ï¼Œåˆ™åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„ sfx
                    if (window.sfxEnabled === false && window.playingSfx) {
                        try {
                            Object.keys(window.playingSfx).forEach(p => {
                                const a = window.playingSfx[p];
                                try { a.pause(); a.currentTime = 0; } catch (e) {}
                                try { delete window.playingSfx[p]; } catch (e) {}
                            });
                        } catch (e) {}
                    }
                } catch (e) { console.warn('åˆ‡æ¢éŸ³æ•ˆå¼€å…³å¤±è´¥', e); }
            });

            // è°ƒè¯•é¢æ¿åˆ‡æ¢
            const debugToggle = document.getElementById('debug-toggle');
            const debugPanel = document.getElementById('debug-panel');
            debugToggle && debugToggle.addEventListener('click', () => {
                if (!debugPanel) return;
                if (debugPanel.style.display === 'none' || !debugPanel.style.display) {
                    debugPanel.style.display = 'block';
                    debugToggle.textContent = 'éšè—è°ƒè¯•';
                } else {
                    debugPanel.style.display = 'none';
                    debugToggle.textContent = 'æ˜¾ç¤ºè°ƒè¯•';
                }
            });

            // éŸ³é‡æ»‘å—ï¼ˆèƒŒæ™¯éŸ³ä¹ï¼‰
            const musicVol = document.getElementById('music-volume');
            musicVol && musicVol.addEventListener('input', (e) => {
                try {
                    const v = parseFloat(e.target.value);
                    const bg = window.bgMusic || document.getElementById('bgMusic');
                    if (bg) {
                        bg.volume = v;
                        if (typeof setBgOriginalVolume === 'function') setBgOriginalVolume(v);
                        else window.bgMusicOriginalVolume = v;
                    }
                } catch (err) { console.warn('è®¾ç½®éŸ³é‡å¤±è´¥', err); }
            });

            // SFX éŸ³é‡æ»‘å—ï¼ˆåŒæ—¶è°ƒæ•´æ­£åœ¨æ’­æ”¾çš„éŸ³æ•ˆï¼‰
            const sfxVol = document.getElementById('sfx-volume');
            sfxVol && sfxVol.addEventListener('input', (e) => {
                try {
                    const v = parseFloat(e.target.value);
                    window.sfxVolume = v;
                    // åŒæ­¥è°ƒæ•´å½“å‰æ­£åœ¨æ’­æ”¾çš„ sfx å®ä¾‹
                    try {
                        const playing = window.playingSfx || {};
                        Object.keys(playing).forEach(k => {
                            const a = playing[k];
                            if (!a) return;
                            try {
                                const base = (typeof a._baseVolume === 'number') ? a._baseVolume : 1;
                                a.volume = Math.max(0, Math.min(1, base * v));
                            } catch (e) {}
                        });
                    } catch (e) {}
                } catch (err) { console.warn('è®¾ç½® sfx éŸ³é‡å¤±è´¥', err); }
            });

            // å¿«é€Ÿæµ‹è¯•æŒ‰é’®ï¼šç›´æ¥åˆ‡æ¢åˆ°ç¬¬1ç« ç¬¬0åœºæ™¯å¹¶å¼€å§‹ï¼ˆä¾¿äºæœ¬åœ°éªŒè¯ï¼‰
            const quickTestBtn = document.getElementById('quick-test');
            quickTestBtn && quickTestBtn.addEventListener('click', () => {
                try {
                    if (typeof startGame === 'function') {
                        startGame();
                        // åŒæ—¶ç¡®ä¿èƒŒæ™¯éŸ³ä¹è¢«å¼€å¯ï¼ˆè‹¥å°šæœªå¼€å¯ï¼‰
                        try {
                            if (window.musicEnabled !== true && typeof toggleMusic === 'function') {
                                toggleMusic();
                            }
                        } catch (e) { console.warn('å¿«é€Ÿæµ‹è¯•å¯åŠ¨éŸ³ä¹æ—¶å‡ºé”™', e); }

                        // ç¡®ä¿åœºæ™¯èƒŒæ™¯è¢«æ›´æ–°ï¼ˆå¦‚æœ loadScene é‡å†™åï¼Œbackground æ›´æ–°ä¼šè§¦å‘ï¼‰
                        if (typeof updateBackground === 'function') updateBackground(window.currentChapter || 1, window.currentScene || 0);
                    } else {
                        console.warn('startGame æœªå®šä¹‰');
                    }
                } catch (e) {
                    console.error('å¿«é€Ÿæµ‹è¯•å‡ºé”™', e);
                }
            });
        })();
    </script>
</body>
</html>